<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qiubite31.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Chase excellence, success will follow!">
<meta property="og:type" content="website">
<meta property="og:title" content="Drake&#39;s">
<meta property="og:url" content="https://qiubite31.github.io/index.html">
<meta property="og:site_name" content="Drake&#39;s">
<meta property="og:description" content="Chase excellence, success will follow!">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Drake">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qiubite31.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>Drake's</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-82135937-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-82135937-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Drake's</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2025/01/26/text-to-sql-by-llm-using-function-calling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/01/26/text-to-sql-by-llm-using-function-calling/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務 - 使用Function Calling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2025-01-26 23:05:51" itemprop="dateCreated datePublished" datetime="2025-01-26T23:05:51+08:00">2025-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-27 02:15:05" itemprop="dateModified" datetime="2025-01-27T02:15:05+08:00">2025-01-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2025/01/26/text-to-sql-by-llm-using-function-calling/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2025/01/26/text-to-sql-by-llm-using-function-calling/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇說明<a href="/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/">Langchain的SQL Agent範例如何透過ReAct Prompting</a>實作，而目前LLM其實都已經具有Function Calling的能力，比起要解析LLM回傳的Action和Action Input再另外執行，直接透過Function Calling的效果其實更好。甚至目前的LLM能力已經可以在不強迫產生Thought的推論動作下模型就能順利解決問題。</p>
<img src="/2025/01/26/text-to-sql-by-llm-using-function-calling/Gemini-Function-Calling.png" class="" width="500">

<div align="center">
  <a target="_blank" rel="noopener" href="https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/function-calling/">Introduction to function calling</a>
</div>

<p>Function Calling可以允許LLM使用外部的API或Function，以克服無法取得最新知識或是外部資料的限制。只要將prompt和可以允許執行的Function提供給LLM，模型就能在處理prompt時選擇能夠處理當下任務的Function並得到回傳資訊。在取得Function所提供的外部回傳資訊後，可以再提供給模型作最後的回答。</p>
<p>下面使用Langchain的SQLDatabase提供執行的Function，與Gemini的Function Calling完成Text-to-SQL任務。</p>
<p>首先建立Chinook資料庫，並使用langchain的SQLDatabase建立資料庫的查詢引擎：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下載 SQL 腳本</span></span><br><span class="line">url = <span class="string">&quot;https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 儲存 SQL 腳本到本地檔案</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 連接到 SQLite 資料庫 (會自動建立資料庫檔案)</span></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;Chinook.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 執行 SQL 腳本來建立資料庫</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cursor.executescript(f.read())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交變更並關閉連接</span></span><br><span class="line">conn.commit()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="comment"># 準備sqlite db</span></span><br><span class="line">db = SQLDatabase.from_uri(<span class="string">&quot;sqlite:///Chinook.db&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Gemini會使用function name, docstring, parameters和parameter type annotations來決定是否要使用特定的函式來回答問題。這裡借用Langchain的SQLDatabase的三個Function並寫好docstring和parameter。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_db_list_tables</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Tool for getting tables names.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        Input is an empty string</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;, &quot;</span>.join(db.get_usable_table_names());</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_db_schema</span>(<span class="params">table_names: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Tool for getting metadata about a SQL database. Get the schema and sample rows for the specified SQL tables.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        table_names: A comma-separated list of the table names for which to return the schema.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> db.get_table_info_no_throw(</span><br><span class="line">            [t.strip() <span class="keyword">for</span> t <span class="keyword">in</span> table_names.split(<span class="string">&quot;,&quot;</span>)]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_db_query</span>(<span class="params">query: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Tool for querying a SQL database. Execute a SQL query against the database and get back the result..</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        query: A detailed and correct SQL query.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> db.run_no_throw(query)</span><br></pre></td></tr></table></figure>

<p>接著設定function calling config，這裡設定成ANY會強迫讓模型使用提供的Function，並提供以上三個Function。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> google.generativeai.types <span class="keyword">import</span> content_types</span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tool_config_from_mode</span>(<span class="params">mode: <span class="built_in">str</span>, fns: Iterable[<span class="built_in">str</span>] = (<span class="params"></span>)</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Create a tool config with the specified function calling mode.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> content_types.to_tool_config(</span><br><span class="line">        &#123;<span class="string">&quot;function_calling_config&quot;</span>: &#123;<span class="string">&quot;mode&quot;</span>: mode, <span class="string">&quot;allowed_function_names&quot;</span>: fns&#125;&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">sql_tool_dict = &#123;</span><br><span class="line">    <span class="string">&quot;sql_db_query&quot;</span>: sql_db_query,</span><br><span class="line">    <span class="string">&quot;sql_db_schema&quot;</span>: sql_db_schema,</span><br><span class="line">    <span class="string">&quot;sql_db_list_tables&quot;</span>: sql_db_list_tables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tool_config = tool_config_from_mode(mode=<span class="string">&quot;any&quot;</span>, fns=<span class="built_in">list</span>(sql_tool_dict.keys()))</span><br></pre></td></tr></table></figure>

<p>以下參考Langchain的prompt內容並擷取prefix當作instruction還有輸入的問題為input。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">instruction = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">You are an agent designed to interact with a SQL database.</span></span><br><span class="line"><span class="string">Given an input question, create a syntactically correct sqlite query to run, then look at the results of the query and return the answer.</span></span><br><span class="line"><span class="string">Unless the user specifies a specific number of examples they wish to obtain, always limit your query to at most 10 results.</span></span><br><span class="line"><span class="string">You can order the results by a relevant column to return the most interesting examples in the database.</span></span><br><span class="line"><span class="string">Never query for all the columns from a specific table, only ask for the relevant columns given the question.</span></span><br><span class="line"><span class="string">You have access to tools for interacting with the database.</span></span><br><span class="line"><span class="string">Only use the below tools. Only use the information returned by the below tools to construct your final answer.</span></span><br><span class="line"><span class="string">You MUST double check your query before executing it. If you get an error while executing a query, rewrite the query and try again.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DO NOT make any DML statements (INSERT, UPDATE, DELETE, DROP etc.) to the database.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If the question does not seem related to the database, just return &quot;I don&#x27;t know&quot; as the answer.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">First, You should look at the tables in the database to see what I can query.  Then I should query the schema of the most relevant tables.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">text2sql_input = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">How many employees are there?</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果使用generate_content會需要手動管理與模型的互動，所以這裡會把將instruction、prompt和tools提供給模型並與模型建立chat session，其中將enable_automatic_function_calling設成True時會允許模型自己呼叫我們所提供的Function。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure Gemini</span></span><br><span class="line">genai.configure(api_key=GEMINI_API_KEY)</span><br><span class="line">model = genai.GenerativeModel(model_name=<span class="string">&#x27;gemini-1.5-flash&#x27;</span>, \</span><br><span class="line">                system_instruction=instruction, \</span><br><span class="line">                tools=<span class="built_in">list</span>(sql_tool_dict.values()))</span><br><span class="line"></span><br><span class="line">chat = model.start_chat(enable_automatic_function_calling=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">response = chat.send_message(text2sql_input)</span><br><span class="line">response.text</span><br></pre></td></tr></table></figure>

<p>最後可以從模型得到正確回答「There are 8 employees.」。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There are 8 employees.</span><br></pre></td></tr></table></figure>

<p>可以從以下的chat history看到模型會從input的內容開始，先呼叫查詢所有的資料表後，接著選出Employee資料表查詢schema資訊，最後下一段模型生成出來的SQL查詢後回答最終的答案。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> content <span class="keyword">in</span> chat.history:</span><br><span class="line">    <span class="built_in">print</span>(content.role, <span class="string">&quot;-&gt;&quot;</span>, [<span class="built_in">type</span>(part).to_dict(part) <span class="keyword">for</span> part <span class="keyword">in</span> content.parts])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">user -&gt; [&#123;&#x27;text&#x27;: &#x27;\nHow many employees are there?\n&#x27;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">model -&gt; [&#123;&#x27;function_call&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_list_tables&#x27;, &#x27;args&#x27;: &#123;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">user -&gt; [&#123;&#x27;function_response&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_list_tables&#x27;, &#x27;response&#x27;: &#123;&#x27;result&#x27;: &#x27;Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track&#x27;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">model -&gt; [&#123;&#x27;function_call&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_schema&#x27;, &#x27;args&#x27;: &#123;&#x27;table_names&#x27;: &#x27;Employee&#x27;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">user -&gt; [&#123;&#x27;function_response&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_schema&#x27;, &#x27;response&#x27;: &#123;&#x27;result&#x27;: &#x27;\nCREATE TABLE &quot;Employee&quot; (\n\t&quot;EmployeeId&quot; INTEGER NOT NULL, \n\t&quot;LastName&quot; NVARCHAR(20) NOT NULL, \n\t&quot;FirstName&quot; NVARCHAR(20) NOT NULL, \n\t&quot;Title&quot; NVARCHAR(30), \n\t&quot;ReportsTo&quot; INTEGER, \n\t&quot;BirthDate&quot; DATETIME, \n\t&quot;HireDate&quot; DATETIME, \n\t&quot;Address&quot; NVARCHAR(70), \n\t&quot;City&quot; NVARCHAR(40), \n\t&quot;State&quot; NVARCHAR(40), \n\t&quot;Country&quot; NVARCHAR(40), \n\t&quot;PostalCode&quot; NVARCHAR(10), \n\t&quot;Phone&quot; NVARCHAR(24), \n\t&quot;Fax&quot; NVARCHAR(24), \n\t&quot;Email&quot; NVARCHAR(60), \n\tPRIMARY KEY (&quot;EmployeeId&quot;), \n\tFOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)\n)\n\n/*\n3 rows from Employee table:\nEmployeeId\tLastName\tFirstName\tTitle\tReportsTo\tBirthDate\tHireDate\tAddress\tCity\tState\tCountry\tPostalCode\tPhone\tFax\tEmail\n1\tAdams\tAndrew\tGeneral Manager\tNone\t1962-02-18 00:00:00\t2002-08-14 00:00:00\t11120 Jasper Ave NW\tEdmonton\tAB\tCanada\tT5K 2N1\t+1 (780) 428-9482\t+1 (780) 428-3457\tandrew@chinookcorp.com\n2\tEdwards\tNancy\tSales Manager\t1\t1958-12-08 00:00:00\t2002-05-01 00:00:00\t825 8 Ave SW\tCalgary\tAB\tCanada\tT2P 2T3\t+1 (403) 262-3443\t+1 (403) 262-3322\tnancy@chinookcorp.com\n3\tPeacock\tJane\tSales Support Agent\t2\t1973-08-29 00:00:00\t2002-04-01 00:00:00\t1111 6 Ave SW\tCalgary\tAB\tCanada\tT2P 5M5\t+1 (403) 262-3443\t+1 (403) 262-6712\tjane@chinookcorp.com\n*/&#x27;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">model -&gt; [&#123;&#x27;function_call&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_query&#x27;, &#x27;args&#x27;: &#123;&#x27;query&#x27;: &#x27;SELECT COUNT(*) FROM Employee&#x27;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">user -&gt; [&#123;&#x27;function_response&#x27;: &#123;&#x27;name&#x27;: &#x27;sql_db_query&#x27;, &#x27;response&#x27;: &#123;&#x27;result&#x27;: &#x27;[(8,)]&#x27;&#125;, &#x27;id&#x27;: &#x27;&#x27;&#125;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">model -&gt; [&#123;&#x27;text&#x27;: &#x27;There are 8 employees.&#x27;&#125;]</span><br><span class="line">--------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>參考資料:<br><a target="_blank" rel="noopener" href="https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/function-calling">Generative-AI function-calling</a><br><a target="_blank" rel="noopener" href="https://github.com/google-gemini/cookbook/blob/main/quickstarts/Function_calling.ipynb">Gemini cookbook Function_Calling</a><br><a target="_blank" rel="noopener" href="https://github.com/google-gemini/cookbook/blob/main/quickstarts/Function_calling_config.ipynb">Gemini cookbook Function_Calling_config</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Agent背後的ReAct Prompting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2025-01-02 22:26:12" itemprop="dateCreated datePublished" datetime="2025-01-02T22:26:12+08:00">2025-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-19 14:00:23" itemprop="dateModified" datetime="2025-01-19T14:00:23+08:00">2025-01-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇<a href="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/">透過Langchain SQL Agent建立資料問答系統</a>中使用了Langchain的create_sql_agent來建立SQL Agent。Langchain在實作這個SQL Agent背後的使用了<a target="_blank" rel="noopener" href="https://python.langchain.com/api_reference/langchain/agents/langchain.agents.react.agent.create_react_agent.html">create_react_agent</a>，這是基於2022年的paper “ReAct: Synergizing Reasoning and Acting in Language Models”的實作，雖然這個版本是比較早期的實作現在並不適合拿來使用在production環境，但仍可以透過瞭解SQL Agent是怎麼基於ReAct prompting技巧運作的。</p>
<h4 id="ReAct-Prompting"><a href="#ReAct-Prompting" class="headerlink" title="ReAct Prompting"></a>ReAct Prompting</h4><p>ReAct Prompting包含了兩個部份，分別是Reasoning和Acting。主要是讓LLM能夠透過交錯的方式產生推理的過程(Reasoning traces)和執行特定任務的動作(task-specific actions)。在產生推理時可以讓LLM針對推理的結果，更新並產生新的執行任務的動作，同時允許LLM在執行任務時可以和外部的工具互動，以取得更具信賴且真實的資訊。</p>
<h5 id="Hotspot-QA"><a href="#Hotspot-QA" class="headerlink" title="Hotspot QA"></a>Hotspot QA</h5><img src="/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/ReAct_case1.png" class="" width="500">

<p>上面是論文中使用的問題「Aside from the Apple Remote, what other devices can control the program Apple Remote was originally designed to interact with?」讓LLM透過ReAct解決問題的推論與執行動作過程。可以看到在找到答案前，每次都會進行思考(Though)、行動(Action)和觀察(Observation)。所以模型會在每一次作完動作得到的觀察結果(例如搜尋結果)後，思考下一步該作什麼動作(例如搜尋某個資訊)。</p>
<h5 id="AlfWorld"><a href="#AlfWorld" class="headerlink" title="AlfWorld"></a>AlfWorld</h5><img src="/2025/01/02/text-to-sql-by-llm-using-langchain-sql-agent-react-prompt/ReAct_case2.png" class="" width="500">

<p>第二個例子是應用在決策任務中，在決策任務中會包含了更複雜的互動環境，因此更需要透過有效的推論過程和執行動作，讓模型最後能完成正確的任務。在解決AlfWorld的問題「You are in the middle of a room. Looking quickly around you, you see a cabinet 6, a cabinet 1, a coffee machine 1, a countertop 3, a stove burner 1, and a toaster 1. Your task is to: Put some pepper shaker on a drawer.」可以看到在中間加入思考推論後，能讓模型正確的把最後的目標拆解更小的目標來完成最終的任務。</p>
<h4 id="ReAct-Prompting-in-SQL-Agent"><a href="#ReAct-Prompting-in-SQL-Agent" class="headerlink" title="ReAct Prompting in SQL Agent"></a>ReAct Prompting in SQL Agent</h4><p>接著我們來看一下在Langchain裡面<a target="_blank" rel="noopener" href="https://api.python.langchain.com/en/latest/_modules/langchain_community/agent_toolkits/sql/base.html#create_sql_agent">SQL Agent</a>用到的ReAct prompting預設是怎麼設計的。在prompt的template組成總共會有四個部份，分別為database prompt，tools，ReAct instructions和Begin and Scratchpad。</p>
<h5 id="Database-Prompt"><a href="#Database-Prompt" class="headerlink" title="Database Prompt"></a>Database Prompt</h5><p>第一個部份是整個prompt的prefix，和<a href="/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain#%E5%92%8CLLM%E4%BA%92%E5%8B%95%E7%9A%84prompt">SQL Chain</a>一樣由Database Prompt組成，會需要置換的參數為dialect、top_k，這裡和SQL Chain一樣。</p>
<figure class="highlight plaintext"><figcaption><span>Database Prompt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">You are an agent designed to interact with a SQL database.</span><br><span class="line">Given an input question, create a syntactically correct &#123;dialect&#125; query to run, then look at the results of the query and return the answer.</span><br><span class="line">Unless the user specifies a specific number of examples they wish to obtain, always limit your query to at most &#123;top_k&#125; results.</span><br><span class="line">You can order the results by a relevant column to return the most interesting examples in the database.</span><br><span class="line">Never query for all the columns from a specific table, only ask for the relevant columns given the question.</span><br><span class="line">You have access to tools for interacting with the database.</span><br><span class="line">Only use the below tools. Only use the information returned by the below tools to construct your final answer.</span><br><span class="line">You MUST double check your query before executing it. If you get an error while executing a query, rewrite the query and try again.</span><br><span class="line"></span><br><span class="line">DO NOT make any DML statements (INSERT, UPDATE, DELETE, DROP etc.) to the database.</span><br><span class="line"></span><br><span class="line">If the question does not seem related to the database, just return &quot;I don&#x27;t know&quot; as the answer.</span><br></pre></td></tr></table></figure>

<h5 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h5><p>第二個部份為所有提供給模型使用的tool與描述，這裡總共提供四種tool，分別為執行SQL(sql_db_query)、查詢Schema(sql_db_schema)、查詢資料表(sql_db_list_tables)和驗證SQL查詢(sql_db_query_checker)。模型會在推論中決定下一個要使用哪一個tool來執行動作。</p>
<figure class="highlight plaintext"><figcaption><span>Toolkit</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sql_db_query - Input to this tool is a detailed and correct SQL query, output is a result from the database. If the query is not correct, an error message will be returned. If an error is returned, rewrite the query, check the query, and try again. If you encounter an issue with Unknown column &#x27;xxxx&#x27; in &#x27;field list&#x27;, use sql_db_schema to query the correct table fields.</span><br><span class="line">sql_db_schema - Input to this tool is a comma-separated list of tables, output is the schema and sample rows for those tables. Be sure that the tables actually exist by calling sql_db_list_tables first! Example Input: table1, table2, table3</span><br><span class="line">sql_db_list_tables - Input is an empty string, output is a comma-separated list of tables in the database.</span><br><span class="line">sql_db_query_checker - Use this tool to double check if your query is correct before executing it. Always use this tool before executing a query with sql_db_query!</span><br></pre></td></tr></table></figure>

<h5 id="ReAct-Instruction"><a href="#ReAct-Instruction" class="headerlink" title="ReAct Instruction"></a>ReAct Instruction</h5><p>第三個部份為ReAct prompting主要的格式，會告訴模型須要進行Thought-Action-Action Input-Observation的循環，直到找到最終的答案。這裡的tool_names參數即為第二部份所有的tool名稱集合。</p>
<p>模型會根據推論(Though)決定執行的行動(Action)，並產生行動輸入(Action Input)。在這裡執行的行動即為使用其中一個tool，而行動輸入就是tool的輸入參數。在執行完行動後的結果就是會產生觀察(Observation)，而模型根據觀察再進行下一步思考推論(Though)，並反覆直到完成任務。</p>
<figure class="highlight plaintext"><figcaption><span>ReAct Format and Instructions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: the input question you must answer</span><br><span class="line">Thought: you should always think about what to do</span><br><span class="line">Action: the action to take, should be one of [&#123;tool_names&#125;]</span><br><span class="line">Action Input: the input to the action</span><br><span class="line">Observation: the result of the action</span><br><span class="line">... (this Thought/Action/Action Input/Observation can repeat N times)</span><br><span class="line">Thought: I now know the final answer</span><br><span class="line">Final Answer: the final answer to the original input question</span><br></pre></td></tr></table></figure>

<h5 id="Begin-and-Scratchpad"><a href="#Begin-and-Scratchpad" class="headerlink" title="Begin and Scratchpad"></a>Begin and Scratchpad</h5><p>第四個部份為Begin與Scratchpad，在這裡會有任務起始的資訊，包含了要回答的問題、最一開始的起始推論，還有儲存推論和行動的暫存器用來紀錄縱跡歷程。這裡的參數共有兩個，第一個input為輸入的問題，第二個agent_scratchpad會紀錄每次的Question-Thought-Action-Action Input-Observation紀錄。</p>
<figure class="highlight plaintext"><figcaption><span>Begin/Input/Scratchpad</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Begin!</span><br><span class="line"></span><br><span class="line">Question: &#123;input&#125;</span><br><span class="line">Thought: I should look at the tables in the database to see what I can query.  Then I should query the schema of the most relevant tables.</span><br><span class="line">&#123;agent_scratchpad&#125;</span><br></pre></td></tr></table></figure>

<h5 id="完整的SQL-Agent-Prompting"><a href="#完整的SQL-Agent-Prompting" class="headerlink" title="完整的SQL Agent Prompting"></a>完整的SQL Agent Prompting</h5><p>以下是使用sqlite範例的完整prompt，其中input會在invoke的時候帶入，而scratchpad會在模型每一次的推論與動作執行紀錄下來。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">You are an agent designed to interact with a SQL database.</span><br><span class="line">Given an input question, create a syntactically correct sqlite query to run, then look at the results of the query and return the answer.</span><br><span class="line">Unless the user specifies a specific number of examples they wish to obtain, always limit your query to at most 10 results.</span><br><span class="line">You can order the results by a relevant column to return the most interesting examples in the database.</span><br><span class="line">Never query for all the columns from a specific table, only ask for the relevant columns given the question.</span><br><span class="line">You have access to tools for interacting with the database.</span><br><span class="line">Only use the below tools. Only use the information returned by the below tools to construct your final answer.</span><br><span class="line">You MUST double check your query before executing it. If you get an error while executing a query, rewrite the query and try again.</span><br><span class="line"></span><br><span class="line">DO NOT make any DML statements (INSERT, UPDATE, DELETE, DROP etc.) to the database.</span><br><span class="line"></span><br><span class="line">If the question does not seem related to the database, just return &quot;I don&#x27;t know&quot; as the answer.</span><br><span class="line"></span><br><span class="line">You have access to the following tools:</span><br><span class="line"></span><br><span class="line">sql_db_query - Input to this tool is a detailed and correct SQL query, output is a result from the database. If the query is not correct, an error message will be returned. If an error is returned, rewrite the query, check the query, and try again. If you encounter an issue with Unknown column &#x27;xxxx&#x27; in &#x27;field list&#x27;, use sql_db_schema to query the correct table fields.</span><br><span class="line">sql_db_schema - Input to this tool is a comma-separated list of tables, output is the schema and sample rows for those tables. Be sure that the tables actually exist by calling sql_db_list_tables first! Example Input: table1, table2, table3</span><br><span class="line">sql_db_list_tables - Input is an empty string, output is a comma-separated list of tables in the database.</span><br><span class="line">sql_db_query_checker - Use this tool to double check if your query is correct before executing it. Always use this tool before executing a query with sql_db_query!</span><br><span class="line"></span><br><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: the input question you must answer</span><br><span class="line">Thought: you should always think about what to do</span><br><span class="line">Action: the action to take, should be one of [sql_db_query, sql_db_schema, sql_db_list_tables, sql_db_query_checker]</span><br><span class="line">Action Input: the input to the action</span><br><span class="line">Observation: the result of the action</span><br><span class="line">... (this Thought/Action/Action Input/Observation can repeat N times)</span><br><span class="line">Thought: I now know the final answer</span><br><span class="line">Final Answer: the final answer to the original input question</span><br><span class="line"></span><br><span class="line">Begin!</span><br><span class="line"></span><br><span class="line">Question: &#123;input&#125;</span><br><span class="line">Thought: I should look at the tables in the database to see what I can query.  Then I should query the schema of the most relevant tables.</span><br><span class="line">&#123;agent_scratchpad&#125;</span><br></pre></td></tr></table></figure>

<p>Scratchpad的過程說明可以參考<a href="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent#SQLAgent%E5%9F%B7%E8%A1%8C%E9%81%8E%E7%A8%8B">SQL Agent執行過程</a>，完整的Scratchpad如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Thought: I should look at the tables in the database to see what I can query.  Then I should query the schema of the most relevant tables.</span><br><span class="line">Action: sql_db_list_tables</span><br><span class="line">Action Input: </span><br><span class="line">Observation: Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br><span class="line">Thought: Thought: The `Employee` table likely contains information about employees. I&#x27;ll check its schema.</span><br><span class="line">Action: sql_db_schema</span><br><span class="line">Action Input: Employee</span><br><span class="line">Observation: </span><br><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br><span class="line">*/</span><br><span class="line">Thought: Thought: I can count the number of rows in the Employee table to find the number of employees.</span><br><span class="line">Action: sql_db_query</span><br><span class="line">Action Input: SELECT COUNT(*) FROM Employee;</span><br><span class="line">Observation: [(8,)]</span><br><span class="line">Thought: I now know the final answer\nFinal Answer: There are 8 employees. </span><br></pre></td></tr></table></figure>


<p>參考資料:<br><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2210.03629">ReAct: Synergizing Reasoning and Acting in Language Models</a><br><a target="_blank" rel="noopener" href="https://www.promptingguide.ai/techniques/react">ReAct Prompting</a><br><a target="_blank" rel="noopener" href="https://python.langchain.com/api_reference/langchain/agents/langchain.agents.react.agent.create_react_agent.html">create_react_agent</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Agent建立資料問答系統</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-05 01:56:08" itemprop="dateCreated datePublished" datetime="2024-12-05T01:56:08+08:00">2024-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-19 13:57:53" itemprop="dateModified" datetime="2025-01-19T13:57:53+08:00">2025-01-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇解釋了如何<a href="/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/">透過Langchain SQL Chain建立資料問答系統</a>。使用 LangChain 的 SQL Chain 可以將問題轉換為 SQL 查詢，這過程中會將不同的動作連結在一起，最後通過執行完整的 Chain 一步步地完成每個步驟，最終獲得結果。如果我們希望 LLM 能夠更主動地與環境互動並完成特定任務，就需要建立代理（Agent）。</p>
<img src="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/agent-overview.png" class="" width="500">

<div align="center">
  <a target="_blank" rel="noopener" href="https://lilianweng.github.io/posts/2023-06-23-agent/">LLM Powered Autonomous Agents</a>
</div>

<p>代理（Agent）可以想像成一個有大腦的系統（LLM），在設定目標後，代理能在無需人為干預的情況下自主完成任務。由於代理需要在每次情境變化時進行思考（Thought）並執行最適當的動作（Action），因此我們需要給代理一個工具箱，讓它能從中選擇最合適的工具（Tool）。此外，代理具有記憶功能，會觀察（Observation）執行結果，並根據情境和環境的變化，不斷調整自己的行為，直到完成任務為止。</p>
<p>在使用Langchain建立SQL Agent前，先把資料庫和大型語言服務準備好。</p>
<h4 id="準備資料庫"><a href="#準備資料庫" class="headerlink" title="準備資料庫"></a>準備資料庫</h4><p>建立Chinook這個資料庫來當作範例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下載 SQL 腳本</span></span><br><span class="line">url = <span class="string">&quot;https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 儲存 SQL 腳本到本地檔案</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 連接到 SQLite 資料庫 (會自動建立資料庫檔案)</span></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;Chinook.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 執行 SQL 腳本來建立資料庫</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cursor.executescript(f.read())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交變更並關閉連接</span></span><br><span class="line">conn.commit()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>使用langchain的SQLDatabase來建立資料庫的查詢引擎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="comment"># 準備sqlite db</span></span><br><span class="line">db = SQLDatabase.from_uri(<span class="string">&quot;sqlite:///Chinook.db&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(db.dialect)</span><br><span class="line"><span class="built_in">print</span>(db.get_usable_table_names())</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite</span><br><span class="line">[(1, &#x27;AC/DC&#x27;), (2, &#x27;Accept&#x27;), (3, &#x27;Aerosmith&#x27;), (4, &#x27;Alanis Morissette&#x27;), (5, &#x27;Alice In Chains&#x27;), (6, &#x27;Antônio Carlos Jobim&#x27;), (7, &#x27;Apocalyptica&#x27;), (8, &#x27;Audioslave&#x27;), (9, &#x27;BackBeat&#x27;), (10, &#x27;Billy Cobham&#x27;)]</span><br></pre></td></tr></table></figure>

<h4 id="準備大型語言模型服務"><a href="#準備大型語言模型服務" class="headerlink" title="準備大型語言模型服務"></a>準備大型語言模型服務</h4><p>再來準備一個大型語言模型服務，這裡使用Gemini當範例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> getpass</span><br><span class="line"><span class="keyword">import</span> google.generativeai <span class="keyword">as</span> genai</span><br><span class="line"><span class="comment"># https://python.langchain.com/docs/integrations/chat/google_generative_ai/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure Gemini</span></span><br><span class="line">GEMINI_API_KEY = getpass.getpass() <span class="comment"># input your gemini api key</span></span><br><span class="line">genai.configure(api_key=GEMINI_API_KEY)</span><br><span class="line"></span><br><span class="line">llm = genai.GenerativeModel(<span class="string">&#x27;gemini-1.5-flash&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="建立SQL-Agent"><a href="#建立SQL-Agent" class="headerlink" title="建立SQL Agent"></a>建立SQL Agent</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits <span class="keyword">import</span> create_sql_agent</span><br><span class="line">agent_executor = create_sql_agent(llm, db=db)</span><br><span class="line"></span><br><span class="line">agent_executor.run(<span class="string">&quot;How many employees are there?&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>建立SQL Agent並輸入問題後，就會得到和<a href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/">SQL Chain</a>一樣的回答結果。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There are 8 employees.</span><br></pre></td></tr></table></figure>

<h4 id="SQLAgent執行過程"><a href="#SQLAgent執行過程" class="headerlink" title="SQLAgent執行過程"></a>SQLAgent執行過程</h4><p>使用SQL Chain和SQL Agent的差別在於，SQL Chain會把整個問答過程的步驟先定義好後依序執行。</p>
<p>Agent是先定義出不同的工具（Tool），並由大語言模型（LLM）這個大腦動態地根據執行當下的情況來思考（Thought）應該執行什麼動作（Action）。此時，LLM會挑選出其中一種工具，決定工具的輸入（Action Input）並執行。接著，LLM會觀察（Observation）執行完的結果，然後進行下一輪的思考/動作/動作輸入/觀察，直到得到最終答案。</p>
<p>下面可以透過把verbose打開看到LLM的思考/動作/動作輸入/觀察的執行過程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits <span class="keyword">import</span> create_sql_agent</span><br><span class="line">agent_executor = create_sql_agent(llm, db=db, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">agent_executor.run(<span class="string">&quot;How many employees are there?&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在Text-to-SQL任務中會先有一個起始的情境，也就是讓LLM要先到資料庫裡找到所有可以查詢的資料表，這時Agent選擇了要執行sql_db_list_tables這個動作，在輸入空值的情況下會得到所有的資料表清單。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> Entering new SQL Agent Executor chain...</span></span><br><span class="line">Thought: I should look at the tables in the database to see what I can query.  Then I should query the schema of the most relevant tables.</span><br><span class="line">Action: sql_db_list_tables</span><br><span class="line">Action Input: </span><br><span class="line">Album, Artist, Customer, Employee, Genre, Invoice, InvoiceLine, MediaType, Playlist, PlaylistTrack, Track</span><br></pre></td></tr></table></figure>

<p>Agent在取得所有資料表清單後，開始進行思考並決定要使用Employee這張資料，因為這張資料表和輸入問題最相關。於是Agent選擇執行sql_db_schema並輸入Employee查詢出這張資料表的schema還有三筆資料。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Thought: The table &#x27;Employee&#x27; likely contains information about employees. I&#x27;ll check its schema.</span><br><span class="line">Action: sql_db_schema</span><br><span class="line">Action Input: Employee</span><br><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br></pre></td></tr></table></figure>

<p>Agent接著在看完Employee的schema和範例資料後，思考完認為可以透過計算這張資料表的列數來回答問題，於是Agent執行sql_db_query並輸入SQL查詢得到查詢結果。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thought: I can count the number of rows in the Employee table to answer the question.</span><br><span class="line">Action: sql_db_query</span><br><span class="line">Action Input: SELECT COUNT(*) FROM Employee;</span><br><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>

<p>Agent在看完查詢結果後認為已經能回答最後答案了，於是回答出最終的答案。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thought: I now know the final answer</span><br><span class="line">Final Answer: There are 8 employees.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Finished chain.</span></span><br><span class="line">There are 8 employees.</span><br></pre></td></tr></table></figure>

<h4 id="Chain和Agent差異"><a href="#Chain和Agent差異" class="headerlink" title="Chain和Agent差異"></a>Chain和Agent差異</h4><p>從Agent在完成Text-to-SQL的任務過程中可以發現，透過Agent可以讓LLM作為大腦來依據不同的情境動態決定下一步該執行什麼動作，Chain和Agent的比較可以參考下表(The table is craeted by Copilot)</p>
<table>
<thead>
<tr>
<th></th>
<th>Chains</th>
<th>Agents</th>
</tr>
</thead>
<tbody><tr>
<td><strong>目的</strong></td>
<td>設計來執行一系列預定的步驟，按照特定順序進行。每個步驟處理輸入並將其傳遞到下一步。</td>
<td>設計來執行動態任務，步驟並非預定。在當前上下文和可用工具的基礎上即時做出決策。</td>
</tr>
<tr>
<td><strong>結構</strong></td>
<td>線性結構，每個步驟明確定義並按順序執行。</td>
<td>使用思考、行動和觀察的循環。根據當前上下文和結果調整步驟。</td>
</tr>
<tr>
<td><strong>靈活性</strong></td>
<td>靈活性較低，遵循預定路徑，不會根據新信息或環境變化動態調整行為。</td>
<td>高度靈活，能夠適應新信息和變化的條件。可以根據當前上下文從多種行動和工具中進行選擇。</td>
</tr>
<tr>
<td><strong>使用案例</strong></td>
<td>適合具有明確線性工作流程的任務，如數據處理管道、文本轉換序列和已知步驟的例行操作。</td>
<td>適用於複雜、不可預測的任務，如互動應用程序、實時決策系統和需要適應行為的任務。</td>
</tr>
<tr>
<td><strong>總結</strong></td>
<td>線性，預定步驟，靈活性較低，適合例行的線性工作流程。</td>
<td>動態，決策循環，高度靈活，適合複雜、適應性任務。</td>
</tr>
</tbody></table>
<p>參考資料:<br><a target="_blank" rel="noopener" href="https://python.langchain.com/v0.1/docs/use_cases/sql/agents/">Q&amp;A over SQL - Agents</a><br><a target="_blank" rel="noopener" href="https://lilianweng.github.io/posts/2023-06-23-agent/">Weng, Lilian. (Jun 2023). “LLM-powered Autonomous Agents”. Lil’Log.</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Chain說明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-11-15 13:26:12" itemprop="dateCreated datePublished" datetime="2024-11-15T13:26:12+08:00">2024-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-18 17:15:43" itemprop="dateModified" datetime="2025-01-18T17:15:43+08:00">2025-01-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇<a href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/">透過Langchain SQL Chain建立資料問答系統</a>中使用Langchain的sql query chain能夠快速開發資料問答功能。雖然Langchain提供了方便的開發模組，但卻封裝了許多與大型語言互動的細節。我們可以嘗試的從原始碼來看幾個Langchain封裝起來的細節。</p>
<h4 id="和LLM互動的prompt"><a href="#和LLM互動的prompt" class="headerlink" title="和LLM互動的prompt"></a>和LLM互動的prompt</h4><p>在這篇<a href="/2024/10/06/text-to-sql-by-llm/">使用大型語言模型(LLM)完成Text-to-SQL任務</a>可以看到要把輸入的問題轉成SQL查詢，和LLM互動時會需要準備prompt，如果有自己準備prompt的話，就能在呼叫<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L36">create_sql_query_chain帶進prompt</a>參數。如果沒有的話，Langchain會預設使用<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py">sql_database的prompt</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.sql_database.prompt <span class="keyword">import</span> SQL_PROMPTS</span><br><span class="line">SQL_PROMPTS[db.dialect].pretty_print() <span class="comment"># sqlite</span></span><br></pre></td></tr></table></figure>

<p>在呼叫<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L33">create_sql_query_chain</a>且沒有提供prompt的情況下，會從SQLDatabase取得<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L116">dialect</a>，再從Langchain的sql_database取出對應資料庫的<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py">prompt</a>。目前Langchain提供11種<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py#L272">database prompt</a>，每一種資料庫的prompt都有所不同，特別是在current date的寫法會不同。</p>
<p>以下是以SQLite為例，這prompt中會有三個在過程中會被帶入的參數，分別為top_k(#2)、table_info(#15)和input(#17)。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">You are a SQLite expert. Given an input question, first create a syntactically correct SQLite query to run, then look at the results of the query and return the answer to the input question.</span><br><span class="line">Unless the user specifies in the question a specific number of examples to obtain, query for at most &#123;top_k&#125; results using the LIMIT clause as per SQLite. You can order the results to return the most informative data in the database.</span><br><span class="line">Never query for all columns from a table. You must query only the columns that are needed to answer the question. Wrap each column name in double quotes (&quot;) to denote them as delimited identifiers.</span><br><span class="line">Pay attention to use only the column names you can see in the tables below. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span><br><span class="line">Pay attention to use date(&#x27;now&#x27;) function to get the current date, if the question involves &quot;today&quot;.</span><br><span class="line"></span><br><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: Question here</span><br><span class="line">SQLQuery: SQL Query to run</span><br><span class="line">SQLResult: Result of the SQLQuery</span><br><span class="line">Answer: Final answer here</span><br><span class="line"></span><br><span class="line">Only use the following tables:</span><br><span class="line">&#123;table_info&#125;</span><br><span class="line"></span><br><span class="line">Question: &#123;input&#125;</span><br></pre></td></tr></table></figure>

<h4 id="prompt內置換的變數"><a href="#prompt內置換的變數" class="headerlink" title="prompt內置換的變數"></a>prompt內置換的變數</h4><h5 id="top-k"><a href="#top-k" class="headerlink" title="top_k"></a>top_k</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># langchain/langchain/chains/sql_database/query.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_sql_query_chain</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    llm: BaseLanguageModel,</span></span></span><br><span class="line"><span class="params"><span class="function">    db: SQLDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    prompt: <span class="type">Optional</span>[BasePromptTemplate] = <span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    k: <span class="built_in">int</span> = <span class="number">5</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment"># top_k = 5</span></span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L37">top_k</a>本身在<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L33">create_sql_query_chain</a>就是一個輸入參數，如果不指定的話預設值會是5。</p>
<h5 id="input"><a href="#input" class="headerlink" title="input"></a>input</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># langchain/langchain/chains/sql_database/query.py</span></span><br><span class="line">inputs = &#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="keyword">lambda</span> x: x[<span class="string">&quot;question&quot;</span>] + <span class="string">&quot;\nSQLQuery: &quot;</span>,</span><br><span class="line">    <span class="string">&quot;table_info&quot;</span>: <span class="keyword">lambda</span> x: db.get_table_info(</span><br><span class="line">        table_names=x.get(<span class="string">&quot;table_names_to_use&quot;</span>)</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># chain.invoke(&#123;&quot;question&quot;: &quot;How many employees are there&quot;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># input = How Many employees are there</span></span><br><span class="line"><span class="comment">#         SQLQuery: </span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L131">input</a>會從參數dict取出question，就是對應到在invoke時帶入的問題，接著會在問題後接SQLQuery用來讓LLM往後生成SQL查詢。</p>
<h5 id="table-info"><a href="#table-info" class="headerlink" title="table_info"></a>table_info</h5><p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L131">table_info</a>會呼叫SQLDatabase的get_table_info函式，這個函式的作用是查找出資料庫內的資料表schmea加三筆資料，而且這裡可以接受帶入一個List參數table_names_to_use正向表列要查的資料表。注意如果不指定資料表，get_table_info會帶出所有的資料表資訊。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.get_table_info(table_names=[<span class="string">&quot;Employee&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>實際使用這個函式並帶入資料表名稱，就會取得以下的資訊。這裡的目的就是要讓LLM看懂資料表名稱、欄位清單，還有範例的資料，讓LLM可以更準確的將問題轉成SQL。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<h4 id="完整的prompt"><a href="#完整的prompt" class="headerlink" title="完整的prompt"></a>完整的prompt</h4><p>總結以上的prompt template加上top_k、table_info和input三個要代入的參數，最後完整丟給LLM的prompt如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">You are a SQLite expert. Given an input question, first create a syntactically correct SQLite query to run, then look at the results of the query and return the answer to the input question.</span><br><span class="line">Unless the user specifies in the question a specific number of examples to obtain, query for at most 5 results using the LIMIT clause as per SQLite. You can order the results to return the most informative data in the database.</span><br><span class="line">Never query for all columns from a table. You must query only the columns that are needed to answer the question. Wrap each column name in double quotes (&quot;) to denote them as delimited identifiers.</span><br><span class="line">Pay attention to use only the column names you can see in the tables below. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span><br><span class="line">Pay attention to use date(&#x27;now&#x27;) function to get the current date, if the question involves &quot;today&quot;.</span><br><span class="line"></span><br><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: Question here</span><br><span class="line">SQLQuery: SQL Query to run</span><br><span class="line">SQLResult: Result of the SQLQuery</span><br><span class="line">Answer: Final answer here</span><br><span class="line"></span><br><span class="line">Only use the following tables:</span><br><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">Question: How Many employees are there</span><br><span class="line">SQLQuery: </span><br></pre></td></tr></table></figure>

<p>如果要把table_names_to_use帶入資料表清單，可以用RunnablePassthrough作assign，注意如果資料表不存在資料庫中會回傳table_names not found in database。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.sql_database.tool <span class="keyword">import</span> QuerySQLDataBaseTool</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line">execute_query = QuerySQLDataBaseTool(db=db, verbose=<span class="literal">True</span>)</span><br><span class="line">write_query = create_sql_query_chain(llm, db)</span><br><span class="line"></span><br><span class="line">chain = (</span><br><span class="line">    <span class="comment"># assign table_names_to_use</span></span><br><span class="line">    RunnablePassthrough.assign(table_names_to_use=RunnableLambda(<span class="keyword">lambda</span> x: [<span class="string">&#x27;Employee&#x27;</span>])) </span><br><span class="line">    | write_query</span><br><span class="line">    | RunnableLambda(<span class="keyword">lambda</span> x: parse_sql(x))</span><br><span class="line">    | execute_query</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;How many employees are there&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Chain建立資料問答系統</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-29 22:36:38" itemprop="dateCreated datePublished" datetime="2024-10-29T22:36:38+08:00">2024-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-18 16:46:52" itemprop="dateModified" datetime="2025-01-18T16:46:52+08:00">2025-01-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>延續上一篇<a href="/2024/10/06/text-to-sql-by-llm/">使用大型語言模型(LLM)完成Text-to-SQL任務</a>，在開發大型語言模型的應用程式時，可以採用像LangChain一樣的開源框架。LangChain目的在幫助開發者建立大型語言模型的應用程式，縮短開發時間並更容易的實現各種複雜的大型語言模型應用程式。</p>
<h4 id="準備資料庫"><a href="#準備資料庫" class="headerlink" title="準備資料庫"></a>準備資料庫</h4><p>一開始先建立Chinook這個資料庫來當作範例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下載 SQL 腳本</span></span><br><span class="line">url = <span class="string">&quot;https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 儲存 SQL 腳本到本地檔案</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 連接到 SQLite 資料庫 (會自動建立資料庫檔案)</span></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;Chinook.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 執行 SQL 腳本來建立資料庫</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cursor.executescript(f.read())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交變更並關閉連接</span></span><br><span class="line">conn.commit()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>接著使用langchain的SQLDatabase來建立資料庫的查詢引擎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="comment"># 準備sqlite db</span></span><br><span class="line">db = SQLDatabase.from_uri(<span class="string">&quot;sqlite:///Chinook.db&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(db.dialect)</span><br><span class="line"><span class="built_in">print</span>(db.get_usable_table_names())</span><br><span class="line">db.run(<span class="string">&quot;SELECT * FROM Artist LIMIT 10;&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite</span><br><span class="line">[(1, &#x27;AC/DC&#x27;), (2, &#x27;Accept&#x27;), (3, &#x27;Aerosmith&#x27;), (4, &#x27;Alanis Morissette&#x27;), (5, &#x27;Alice In Chains&#x27;), (6, &#x27;Antônio Carlos Jobim&#x27;), (7, &#x27;Apocalyptica&#x27;), (8, &#x27;Audioslave&#x27;), (9, &#x27;BackBeat&#x27;), (10, &#x27;Billy Cobham&#x27;)]</span><br></pre></td></tr></table></figure>

<h4 id="準備大型語言模型服務"><a href="#準備大型語言模型服務" class="headerlink" title="準備大型語言模型服務"></a>準備大型語言模型服務</h4><p>再來準備一個大型語言模型服務，這裡使用Gemini當範例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> getpass</span><br><span class="line"><span class="keyword">import</span> google.generativeai <span class="keyword">as</span> genai</span><br><span class="line"><span class="comment"># https://python.langchain.com/docs/integrations/chat/google_generative_ai/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure Gemini</span></span><br><span class="line">GEMINI_API_KEY = getpass.getpass() <span class="comment"># input your gemini api key</span></span><br><span class="line">genai.configure(api_key=GEMINI_API_KEY)</span><br><span class="line"></span><br><span class="line">llm = genai.GenerativeModel(<span class="string">&#x27;gemini-1.5-flash&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="使用LangChain"><a href="#使用LangChain" class="headerlink" title="使用LangChain"></a>使用LangChain</h4><p>在LangChain中「Chain」是代表一組有順序執行的步驟或是一系列連接在一起的組件，可以把Chain視為一個工作流程，其中每個步驟都由一個特定的組件負責。每一個組件可能是語言模型、資料來源或是API，這些組件經由連接後可以形成一個完整的應用程式，進而建構更複雜模型推論應用。</p>
<h5 id="使用create-sql-query-chain"><a href="#使用create-sql-query-chain" class="headerlink" title="使用create_sql_query_chain"></a>使用create_sql_query_chain</h5><p>準備好資料庫和大型語言模型服務後，透過create_sql_query_chain建立一個SQL查詢的Chain，這個Chain能夠在給定的資料庫下生成SQL查詢。前面使用的SQLDatabase則可以在這裡用來查詢資料庫類型和調用get_table_info來取得欄位資訊。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_sql_query_chain</span><br><span class="line"></span><br><span class="line">chain = create_sql_query_chain(llm, db)</span><br><span class="line">response = chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;How many employees are there&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;response: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>這裡使用到的create_sql_query_chain會把使用者輸入的文字轉成以下的SQL查詢</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response: SQLQuery: SELECT COUNT(*) FROM Employee</span><br></pre></td></tr></table></figure>

<p>接著可以詠唱一段解析程式把SQL取出來後對資料庫下查詢。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prompt: write a regular expression to parse all substring start from &quot;SQLQuery: &quot;</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_sql</span>(<span class="params">answer</span>):</span></span><br><span class="line">    match = re.search(<span class="string">r&quot;SQLQuery: (.*)&quot;</span>, answer)</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">sql_str = parse_sql(response)</span><br><span class="line">db.run(sql_str)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>

<h5 id="Chain起生成SQL到下查詢"><a href="#Chain起生成SQL到下查詢" class="headerlink" title="Chain起生成SQL到下查詢"></a>Chain起生成SQL到下查詢</h5><p>再來可以把這些動作都Chain起來，步驟會是(1) 將輸入問題透過LLM生成出SQL查詢 (2) 從生成結果解析出SQL (3) 對資料庫下SQL查詢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.sql_database.tool <span class="keyword">import</span> QuerySQLDataBaseTool</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"></span><br><span class="line">execute_query = QuerySQLDataBaseTool(db=db, verbose=<span class="literal">True</span>)</span><br><span class="line">write_query = create_sql_query_chain(llm, db)</span><br><span class="line"><span class="comment"># 生成SQL查詢 -&gt; 解析出SQL -&gt; 下查詢</span></span><br><span class="line">chain = write_query | RunnableLambda(<span class="keyword">lambda</span> x: parse_sql(x)) | execute_query</span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;How many employees are there&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>

<h5 id="把查詢結果轉換成人話"><a href="#把查詢結果轉換成人話" class="headerlink" title="把查詢結果轉換成人話"></a>把查詢結果轉換成人話</h5><p>到這裡已經可以自動化的從輸入問題到生成結果並查詢資料庫，這時如果不想讓Agent只有回覆查詢數字，就可以把資料庫的查詢結果再丟給LLM生成出像人一樣的回答。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line">answer_prompt = PromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Given the following user question, corresponding SQL query, and SQL result, answer the user question.</span></span><br><span class="line"><span class="string">Question: &#123;question&#125;</span></span><br><span class="line"><span class="string">SQL Query: &#123;query&#125;</span></span><br><span class="line"><span class="string">SQL Result: &#123;result&#125;</span></span><br><span class="line"><span class="string">Answer: &quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">answer = answer_prompt | llm | StrOutputParser()</span><br><span class="line">chain = (</span><br><span class="line">    RunnablePassthrough</span><br><span class="line">        .assign(query=write_query) <span class="comment"># answer_prompt中的query參數 = SQLQuery: SELECT COUNT(*) FROM Employee</span></span><br><span class="line">        .assign(result=itemgetter(<span class="string">&quot;query&quot;</span>) | RunnableLambda(<span class="keyword">lambda</span> x: parse_sql(x)) | execute_query <span class="comment"># answer_prompt中的result參數 = [(8,)]</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 到這裡會把放進answer_prompt裡面的dict準備好</span></span><br><span class="line">    <span class="comment"># &#123;&#x27;question&#x27;: &#x27;How many employees are there&#x27;,</span></span><br><span class="line">    <span class="comment"># &#x27;query&#x27;: &#x27;SQLQuery: SELECT COUNT(*) FROM &quot;Employee&quot;&#x27;,</span></span><br><span class="line">    <span class="comment"># &#x27;result&#x27;: &#x27;[(8,)]&#x27;&#125;</span></span><br><span class="line">    | answer </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;How many employees are there&quot;</span>&#125;) <span class="comment"># answer_prompt中的question = How many employees are there</span></span><br></pre></td></tr></table></figure>

<p>從answer_prompt可以看到把question、query、result組成prompt後，就可以請LLM生成一個答案。所以完整的步驟會有四個 (1) 將輸入問題透過LLM生成出SQL查詢 (2) 從生成結果解析出SQL (3) 對資料庫下SQL查詢 (4) 將查詢結果透過LLM生成自然語言回答</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There are 8 employees.</span><br></pre></td></tr></table></figure>

<p>LangChain提供了開發大型語言模型所需要的組件，透過上面的範例可以快速的建立Text-to-SQL核心功能，加速開發大型語言應用程式。</p>
<p>參考資料: <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/tutorials/sql_qa/">Build a Question/Answering system over SQL data</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/10/06/text-to-sql-by-llm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/06/text-to-sql-by-llm/" class="post-title-link" itemprop="url">使用大型語言模型(LLM)完成Text-to-SQL任務</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-10-06 18:47:12" itemprop="dateCreated datePublished" datetime="2024-10-06T18:47:12+08:00">2024-10-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-01-18 16:59:41" itemprop="dateModified" datetime="2025-01-18T16:59:41+08:00">2025-01-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/10/06/text-to-sql-by-llm/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/10/06/text-to-sql-by-llm/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Text-to-SQL（Text2SQL）是一種自然語言處理（NLP）技術，旨在將自然語言文本自動轉換為SQL查詢語句。這項技術的核心在於將用戶輸入的自然語言描述轉換為結構化的SQL查詢，使這些查詢可以在關聯式資料庫中執行。</p>
<p>在現代化的數據平台中，通常會提供自助服務環境，讓使用者在獲得資料存取權限後，可以自行進行數據分析。然而，有時使用者所面臨的問題並不需要將資料匯入Power BI或Tableau等BI工具進行可視化分析，而只是希望在資料中透過查詢、篩選、聚合運算找到答案。</p>
<p>在這種情境下，對於不熟悉SQL的使用者來說，Text-to-SQL服務是一個很好的解決方案，因為它可以幫助使用者輕鬆地將自然語言轉換為SQL查詢，從而快速獲得所需的數據。</p>
<p>拜大型語言模型(LLM)的普及，Text-to-SQL可以很容易的透過LLM完成。以下透過建立Chinook這個SQLite範例資料庫來當作Text-to-SQL任務中查詢用的關聯式資料庫：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下載 SQL 腳本</span></span><br><span class="line">url = <span class="string">&quot;https://raw.githubusercontent.com/lerocha/chinook-database/master/ChinookDatabase/DataSources/Chinook_Sqlite.sql&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 儲存 SQL 腳本到本地檔案</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 連接到 SQLite 資料庫 (會自動建立資料庫檔案)</span></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;Chinook.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 執行 SQL 腳本來建立資料庫</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Chinook_Sqlite.sql&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cursor.executescript(f.read())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交變更並關閉連接</span></span><br><span class="line">conn.commit()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>查詢資料表清單可以看到這個範例資料庫裡面包含了總共有11張資料表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">con = sqlite3.connect(<span class="string">&quot;Chinook.db&quot;</span>)</span><br><span class="line">cursorObj = con.cursor()</span><br><span class="line">cursorObj.execute(<span class="string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27;;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(cursorObj.fetchall())</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; [(<span class="string">&#x27;Album&#x27;</span>,), (<span class="string">&#x27;Artist&#x27;</span>,), (<span class="string">&#x27;Customer&#x27;</span>,), (<span class="string">&#x27;Employee&#x27;</span>,), (<span class="string">&#x27;Genre&#x27;</span>,), (<span class="string">&#x27;Invoice&#x27;</span>,), (<span class="string">&#x27;InvoiceLine&#x27;</span>,), (<span class="string">&#x27;MediaType&#x27;</span>,), (<span class="string">&#x27;Playlist&#x27;</span>,), (<span class="string">&#x27;PlaylistTrack&#x27;</span>,), (<span class="string">&#x27;Track&#x27;</span>,)]</span></span><br></pre></td></tr></table></figure>

<p>以Employee這張資料表為例子，可以將資料表名稱和欄位清單提供給Gemini，並請Gemini將問題轉成SQL:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> getpass</span><br><span class="line"><span class="keyword">import</span> google.generativeai <span class="keyword">as</span> genai</span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Please convert question into SQL query by following table and column information.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">table: Employee</span></span><br><span class="line"><span class="string">column: EmployeeId, LastName, FirstName, Title, ReportsTo, BirthDate, HireDate, Address, City, State, Country, PostalCode, Phone, Fax, Email</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: How many employees come from Canada?</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure Gemini</span></span><br><span class="line">GEMINI_API_KEY = getpass.getpass() <span class="comment"># input your gemini api key</span></span><br><span class="line">genai.configure(api_key=GEMINI_API_KEY)</span><br><span class="line"></span><br><span class="line">model = genai.GenerativeModel(<span class="string">&#x27;gemini-1.5-flash&#x27;</span>)</span><br><span class="line">response = model.generate_content(prompt)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<p>可以看到Gemini依據prompt生成了一段SQL，直接讀這段SQL也有符合前面給的問題。</p>
<figure class="highlight console"><figcaption><span>Gnerated SQL Query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) AS &quot;Number of Canadian Employees&quot;</span><br><span class="line">FROM Employee</span><br><span class="line">WHERE Country = &#x27;Canada&#x27;;</span><br></pre></td></tr></table></figure>

<p>直接把這段SQL拿去查詢資料庫也能得到正確答案，所以在提供資料表和欄位清單的情況下，LLM確實可以生成出能執行的SQL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cursorObj.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">SELECT COUNT(*) AS &quot;Number of Canadian Employees&quot;</span></span><br><span class="line"><span class="string">FROM Employee</span></span><br><span class="line"><span class="string">WHERE Country = &#x27;Canada&#x27;;&quot;&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(cursorObj.fetchall())</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><figcaption><span>Query Result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>

<p>到這裡可以發現，如果要作出一個簡單的Text-to-SQL服務，只要依據使用者的問題找到正確的資料表，接著將提示詞、資料表資訊與問題提供給LLM就可以詠唱出一段「可能」可以執行的SQL語法。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/03/21/migrate-rdbms-to-cassandra-approach/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/21/migrate-rdbms-to-cassandra-approach/" class="post-title-link" itemprop="url">如何將現有的專案與RDBMS轉移到Cassandra</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-03-21 21:42:33" itemprop="dateCreated datePublished" datetime="2024-03-21T21:42:33+08:00">2024-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-04-21 17:43:44" itemprop="dateModified" datetime="2024-04-21T17:43:44+08:00">2024-04-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL-NoSQL/" itemprop="url" rel="index"><span itemprop="name">SQL&NoSQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/03/21/migrate-rdbms-to-cassandra-approach/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/03/21/migrate-rdbms-to-cassandra-approach/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>當專案已經準備要導入Cassandra時，可能是專案已經遇到某些困難與瓶頸，並已經考慮採用Cassandra是一個正確的使用情境。以下是使用<a target="_blank" rel="noopener" href="https://live-datastaxd8.pantheonsite.io/sites/default/files/content/ebook/2020-04/9781492079514%20%282%29.pdf">Cassandra: The Definitive Guide, Third Edition</a>其中第十五章的部份段落來說明如何將資料表轉移到Cassandra上。</p>
<p>要將關聯式資料庫轉到Cassandra上，第一個遇到的問題就是如何將原本的資料表關係轉移到Cassandra上。一種方式是將既有的資料模型作直接轉譯(Direct Translation)，以下會舉旅館預約系統來說明如何對資料模型作直接轉譯。</p>
<img src="/2024/03/21/migrate-rdbms-to-cassandra-approach/reservation_relational_model.png" class="" width="500">

<p>在將關聯式資料庫的資料表直接轉譯到Cassandra上，會分成二個部份：</p>
<ol>
<li>轉譯實體(Translation Entities)</li>
<li>轉譯關聯(Translation Relationships)</li>
</ol>
<h4 id="轉譯實體-Translation-Entities"><a href="#轉譯實體-Translation-Entities" class="headerlink" title="轉譯實體(Translation Entities)"></a>轉譯實體(Translation Entities)</h4><img src="/2024/03/21/migrate-rdbms-to-cassandra-approach/entity_translation.png" class="" width="500">

<ol>
<li> 根據主鍵設定建立相似鍵值的Cassandra資料表<br>首先找到原本關聯式資料模型中的實體。比如說Hotel這張資料表會被預約系統查詢使用，這時就可以在Cassandra也建立一個具有相似鍵值的資料表，即為上圖的hotels資料表，其中參照原本的設定將hotel_id設定成主鍵(在這裡亦為partition key)。</li>
<li> 建立<a href="https://qiubite31.github.io/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/">反正規化資料表</a>滿足不同查詢組合<br>因為並不是所有的查詢都是透過hotel_id查詢，假設要滿足使用name來查詢hotel資料的行為，那就需要建立另一張以name欄位為partition key的資料表叫hotels_by_name。這裡的主鍵為name和hotel_id組合，其中hotel_id為clustering key。</li>
<li>使用<a target="_blank" rel="noopener" href="https://docs.datastax.com/en/cql-oss/3.3/cql/cql_using/useCreateUDT.html">UDT(User-defined Type)</a>描述複雜的型別資料<br>在資料表中的address可以是一個單純的字串表示地址，也可以是一個自定義的型別。因為在Cassandra中可以透過自定義型別來描述複雜的型別資料，以自定義型別Address來說，其中可以包含street、city等多個欄位的屬性。自定義型別並不是必須的，可以依系統的設計需求來考慮是否採用。</li>
</ol>
<h4 id="轉譯關聯-Translation-Relationships"><a href="#轉譯關聯-Translation-Relationships" class="headerlink" title="轉譯關聯(Translation Relationships)"></a>轉譯關聯(Translation Relationships)</h4><img src="/2024/03/21/migrate-rdbms-to-cassandra-approach/relationship_translation.png" class="" width="500">

<p>將實體的資料表轉譯到Cassandra的資料表後，接著就可以開始看這些實體資料表間的關聯性。以RoomToAmenity來說，這張為其實是描述Room和Amenity之間的關聯，而這類的關聯資料表常常沒有自己的屬性，可以看到RoomID和AmenityID這兩個欄位組成的主鍵，同時也分別是連接到Room和Amenity的外部鍵。</p>
<ol>
<li>將實體資料表間的關聯性建立Cassandra資料表<br>這些被用來表達實體間關聯的資料表，時常伴隨著實體資料表作使用。以amenities_by_room為例，這張資料表的主鍵會拿實體資料表中的鍵值作為查詢用的partition key(hotel_id, room_number)。因此在查詢時就可以從hotel_id查詢某一間room_number提供的amenities。 </li>
<li>使用UDT描述從屬資料<br>以右下角rooms_by_hotel資料表為例，這張表是透過hotel_id查詢所有的room資料，這時可以設計一個amenity自定義型態，並設定amenities欄位是list of amenity型態。這種設計的好處在於可以透過一個查詢就一併查出room相關的amenities資料，不需要分多次查詢。當然UDT的使用也是依系統的設計需求來考慮是否採用。</li>
</ol>
<p>以上就是採用直接轉譯的方式將原本關聯式資料表轉成Cassandra資料表，這種方式好處在於可以直接對準在原本的資料模型作轉移，一步一步從實體資料表、資料表關聯還有結合應用層的查詢條件將專案作轉移。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/" class="post-title-link" itemprop="url">在採用Cassandra前你必須要知道的事-沒有JOIN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-02-28 14:23:30" itemprop="dateCreated datePublished" datetime="2024-02-28T14:23:30+08:00">2024-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-03-03 17:42:34" itemprop="dateModified" datetime="2024-03-03T17:42:34+08:00">2024-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL-NoSQL/" itemprop="url" rel="index"><span itemprop="name">SQL&NoSQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>關聯式資料庫的使用者在使用Cassandra設計資料模型時，通常第一個會遇到的問題就是不能使用join。Cassandra明確說明不支援join，建議的方式為建立一個反正規化(Denormalization)的資料表。</p>
<h4 id="什麼叫反正規化-Denormalization"><a href="#什麼叫反正規化-Denormalization" class="headerlink" title="什麼叫反正規化(Denormalization)"></a>什麼叫反正規化(Denormalization)</h4><p>有別於關聯式資料庫的正規化(Normalization)設計，透過減少資料庫內的資料冗餘(Data Redundancy)和去除相依性來增進資料的一致性。這種方式的缺點在當資料被拆成多個資料表後，依不同使用情境下將資料join起來查詢時，會導致效能不佳。</p>
<p>而反正規化則是相反，反正規化會增加資料冗餘或是對資料進行分組，來得到最佳化的讀取效能。所以在反正規化的實例中，會把預先join完的資料建成一張資料表，這時就會有同一份資料被複製成多張資料表的情況。</p>
<h4 id="怎麼將反正規化應用在資料設計"><a href="#怎麼將反正規化應用在資料設計" class="headerlink" title="怎麼將反正規化應用在資料設計"></a>怎麼將反正規化應用在資料設計</h4><h5 id="關聯式資料庫正規化設計"><a href="#關聯式資料庫正規化設計" class="headerlink" title="關聯式資料庫正規化設計"></a>關聯式資料庫正規化設計</h5><p>舉DataStax的課程<a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PL2g2h-wyI4SqIigskyJNAeL2vSTJZU_Qp">DS220.08</a>範例來說明。這個範例為電影資料庫被設計成videos、users和comments三張資料表。</p>
<img src="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/typical_relational_structure.png" class="" width="500">

<p>如果想要依電影標題查詢評論時，可以使用videos的id和comments的video_id將兩張表join起來，這時就可以使用videos的title欄位查詢出對應的comment資訊。</p>
<img src="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/query_comment_by_video.png" class="" width="500">

<p>如果要依會員帳號查詢評論時，則是使用users的id和comments的user_id將兩張表join起來，接著就可以使用users的login欄位查詢出該會員帳號留過的評論。</p>
<img src="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/query_comment_by_user.png" class="" width="500">

<h5 id="Cassandra反正規化設計"><a href="#Cassandra反正規化設計" class="headerlink" title="Cassandra反正規化設計"></a>Cassandra反正規化設計</h5><p>在Cassandra的反正規化資料模型設計會直接建立成兩張資料表，並透過不同的primary key來提供兩種查詢方式。第一張comments_by_video會將video_title設定成partition key，第二張comments_by_user會將user_login設計成partition key。</p>
<img src="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/denormalizing_for_query_performance.png" class="" width="500">

<p>因為Cassandra會使用partition key決定存放資料的位置，因為在作Cassandra的資料模型設計時，要查詢的欄位都必須被設計成partition key才能達到最佳的查詢效能。以這個例子來說，這兩張表的建立資料表指令如下，可以看的出來兩張資料表幾乎有共通的欄位，只差在partition key的設計不同。</p>
<img src="/2024/02/28/before-adopt-cassandra-you-need-to-know-no-join/denormalizing_for_query_performance2.png" class="" width="500">

<p>這就是反正規化中對資料作pre-join並且會將資料複製成多張資料表的作法。而目的就是為了要讓查詢的效能可以最佳化，不需要在查詢時面對可能不可控的join結果，或是複雜的join行為帶來的查詢效能低落。</p>
<p><a target="_blank" rel="noopener" href="https://cassandra.apache.org/doc/stable/cassandra/data_modeling/data_modeling_rdbms.html#no-joins">Cassandra Data Modeling - No Join</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PcH9b0janp0">DS220.08 Denormalization</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/01/27/before-adopt-cassandra-you-need-to-know-cql-orderby/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/01/27/before-adopt-cassandra-you-need-to-know-cql-orderby/" class="post-title-link" itemprop="url">在採用Cassandra前你必須要知道的事-CQL怎麼ORDERBY</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-01-27 18:34:38" itemprop="dateCreated datePublished" datetime="2024-01-27T18:34:38+08:00">2024-01-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-03-03 14:46:12" itemprop="dateModified" datetime="2024-03-03T14:46:12+08:00">2024-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL-NoSQL/" itemprop="url" rel="index"><span itemprop="name">SQL&NoSQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/01/27/before-adopt-cassandra-you-need-to-know-cql-orderby/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/01/27/before-adopt-cassandra-you-need-to-know-cql-orderby/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SQL開發者在查詢完資料後，往往會使用ORDER BY語法對查詢結果作排序調整。Cassandra的排序是對partition中的資料作排序，而且這個排序必須在建立資料表時就先定義好，並不能在查詢時使用任意的欄位改變排序。</p>
<p>Cassandra在建立資料表時定義的partition key決定資料存放的位置，並在每份partion中使用clustering key決定資料的排序，而且資料在寫入Cassandra時就會依據clustering key定義的欄位順序將資料排序好。</p>
<p>以下用員工表範例來作說明：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- create</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> CASSANDRA.EMPLOYEE (</span><br><span class="line">  deptName text,</span><br><span class="line">  jobgrade text,</span><br><span class="line">  empId text,</span><br><span class="line">  name text,</span><br><span class="line">  gender text,</span><br><span class="line">  <span class="keyword">primary</span> key(deptName, jobgrade, gender, empId)</span><br><span class="line">) <span class="keyword">WITH</span> CLUSTERING <span class="keyword">ORDER</span> <span class="keyword">BY</span> (jobgrade <span class="keyword">ASC</span>, gender <span class="keyword">ASC</span>, empId <span class="keyword">ASC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- insert</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;001&#x27;</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;002&#x27;</span>, <span class="string">&#x27;Amy&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;003&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;004&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;005&#x27;</span>, <span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;006&#x27;</span>, <span class="string">&#x27;Henry&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- select</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE;</span><br><span class="line"></span><br><span class="line">deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">005</span> <span class="operator">|</span>  Mary</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">001</span> <span class="operator">|</span>   Tom</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">002</span> <span class="operator">|</span>   Amy</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">004</span> <span class="operator">|</span> Alice</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">003</span> <span class="operator">|</span>  John</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">006</span> <span class="operator">|</span> Henry</span><br></pre></td></tr></table></figure>

<h4 id="在建立資料表時決定資料排序"><a href="#在建立資料表時決定資料排序" class="headerlink" title="在建立資料表時決定資料排序"></a>在建立資料表時決定資料排序</h4><p>從以上的範例可以看到定義的clustering key包含了jobgrade、gender和empId，也可以發現資料查詢出來預設就會依照這三個欄位排序。因為Cassandra在執行資料寫入時，就已經將排序完成了，所以查詢出來就是排序後的結果。<br>像是HR部門的資料，雖然有一筆jobgrade為1的資料後來才寫入，但仍然會被排序在jobgrade為3的資料前面。</p>
<p>我們可以嘗試再寫入一筆測試看看：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;007&#x27;</span>, <span class="string">&#x27;Grace&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;Design&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+-------</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">004</span> <span class="operator">|</span> Alice</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">007</span> <span class="operator">|</span> Grace</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">003</span> <span class="operator">|</span>  John</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">006</span> <span class="operator">|</span> Henry</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>從上面新增的資料和查詢結果，可以發現這筆資料先依jobgrade被排序在1和3中間，再依gender排序在Male前面。</p>
<h4 id="ORDER-BY的使用限制"><a href="#ORDER-BY的使用限制" class="headerlink" title="ORDER BY的使用限制"></a>ORDER BY的使用限制</h4><p>也因為Cassandra的特性，在下CQL查詢時使用ORDER BY時會有以下幾個限制:</p>
<ol>
<li>ORDER BY只能支援partition key有給定的情況</li>
<li>ORDER BY的欄位必須被定義在clustering key中</li>
<li>ORDER BY的欄位順序必須符合clustering key定義的順序</li>
<li>ORDER BY的欄位正/逆排方向必須和clustering key定義的欄位正/逆排方向一致</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 對HR部門的職等作逆排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="comment">-- 符合限制1</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> jobgrade <span class="keyword">DESC</span>; <span class="comment">-- 符合限制2</span></span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">002</span> <span class="operator">|</span>  Amy</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">001</span> <span class="operator">|</span>  Tom</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">005</span> <span class="operator">|</span> Mary</span><br></pre></td></tr></table></figure>

<h5 id="必須依照clustering-key順序"><a href="#必須依照clustering-key順序" class="headerlink" title="必須依照clustering key順序"></a>必須依照clustering key順序</h5><p>Cassandra可以將原本定義好的排序在查詢時轉向，因此會將資料依jobgrade改成從大到小排序。又因為資料已經依clustering key的欄位順序與方向關係儲存下來了，所以gender和empid會連帶隨jobgrade的排序轉向而一起轉向。</p>
<p>接著再來看下面這支CQL，如果不依clustering key定義的欄位順序排序會發生什麼事：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 對HR部門的員工編號與性別逆排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="comment">-- 符合限制1</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> empid <span class="keyword">DESC</span>, gender <span class="keyword">DESC</span>; <span class="comment">-- 違反限制2&amp;3 (跳過jobgrade且欄位順序不符)</span></span><br><span class="line"></span><br><span class="line">InvalidRequest: Error <span class="keyword">from</span> server: code<span class="operator">=</span><span class="number">2200</span> [Invalid query] message<span class="operator">=</span>&quot;Order by currently only supports the ordering of columns following their declared order in the PRIMARY KEY&quot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="comment">-- 符合限制1</span></span><br><span class="line">   <span class="keyword">AND</span> jobgrade <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> gender <span class="keyword">DESC</span>, empid <span class="keyword">DESC</span>;  <span class="comment">-- 符合限制2&amp;3 (已綁定jobgrade且剩下欄位順序正確)</span></span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">001</span> <span class="operator">|</span>  Tom</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">005</span> <span class="operator">|</span> Mary</span><br></pre></td></tr></table></figure>

<p>如果想對員工編號與性別作逆排序，這時會違反clustering key的順序，就會看到Cassandra跳出Order by只支援PRIMARY KEY宣告的欄位順序的錯誤訊息。因為Cassandra在建立資料表時就已經決定好資料儲存的順序，除非對前面順序的clustering key下filter否則不能跳過，並且排序的欄位順序須符合clustering key的定義。</p>
<h5 id="必須符合clustering-key排序方向"><a href="#必須符合clustering-key排序方向" class="headerlink" title="必須符合clustering key排序方向"></a>必須符合clustering key排序方向</h5><p>接著再來看下面這支CQL，如果欄位正/逆排方向和clustering key定義的欄位正/逆排方向不一致會發生什麼事：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="comment">-- 符合限制1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> jobgrade <span class="keyword">DESC</span>, gender <span class="keyword">ASC</span>, empid <span class="keyword">DESC</span>;  <span class="comment">-- 符合限制2&amp;3但違反限制4</span></span><br><span class="line"></span><br><span class="line">InvalidRequest: Error <span class="keyword">from</span> server: code<span class="operator">=</span><span class="number">2200</span> [Invalid query] message<span class="operator">=</span>&quot;Unsupported order by relation&quot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span> <span class="comment">-- 符合限制1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> jobgrade <span class="keyword">DESC</span>, gender <span class="keyword">DESC</span>, empid <span class="keyword">DESC</span>;  <span class="comment">-- 符合限制2&amp;3&amp;4</span></span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">002</span> <span class="operator">|</span>  Amy</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">001</span> <span class="operator">|</span>  Tom</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">005</span> <span class="operator">|</span> Mary</span><br></pre></td></tr></table></figure>

<p>因為建資料表時已經決定每個欄位的排序方向組合，因為在查詢時如果要作排序轉向，就必須要滿足每個欄位的方向都作轉向。以這個資料表為例，三個欄位宣告為ASC，在排序轉向時就必須都要是DESC，否則Cassandra是無法把順序排出來的。</p>
<p>如果排序結果又沒辦法透過CQL達成的話，只能重建新的資料表，或是將資料表讀進程式裡面再作排序了。</p>
<p>為了讓資料查詢的速度可以提升，Cassandra嚴格限制資料排序都必須要預先設計與定義，即查詢出來就是排序好的結果，而不是在查詢時才作排序。正因為Cassandra的data modeling是query-driven的，必須先分析未來資料查詢的需求包含查詢欄位、排序順序，這可能會和RDBMS的使用經驗不同，也是在使用Cassandra前必須要有的思維轉換。</p>
<p>參考資料: </p>
<p><a target="_blank" rel="noopener" href="https://cassandra.apache.org/doc/stable/cassandra/data_modeling/data_modeling_rdbms.html#sorting-is-a-design-decision">Cassandra Data Modeling - Sorting is a design decision</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.datastax.com/en/dse/6.7/cql/cql/cql_reference/cql_commands/cqlSelect.html#cqlSelect__compound-primary-keys">DataStax document - Using compound primary keys and sorting results</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=svoI3ytd-TQ">Dear DataStax Episode 18: How can you order by any field in Cassandra?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2023/12/24/before-adopt-cassandra-you-need-to-know-cql-groupby/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/24/before-adopt-cassandra-you-need-to-know-cql-groupby/" class="post-title-link" itemprop="url">在採用Cassandra前你必須要知道的事-CQL怎麼GROUPBY</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2023-12-24 23:15:00" itemprop="dateCreated datePublished" datetime="2023-12-24T23:15:00+08:00">2023-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-02-29 00:50:56" itemprop="dateModified" datetime="2024-02-29T00:50:56+08:00">2024-02-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL-NoSQL/" itemprop="url" rel="index"><span itemprop="name">SQL&NoSQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2023/12/24/before-adopt-cassandra-you-need-to-know-cql-groupby/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/12/24/before-adopt-cassandra-you-need-to-know-cql-groupby/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SQL開發者絕對少不了會使用聚合函式對資料作加總、平均、計數和取大小值，而Cassandra也支援了SUM、AVG、COUNT、和MIN/MAX的聚合函式。以下用員工表範例來作說明。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- create</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> CASSANDRA.EMPLOYEE (</span><br><span class="line">  deptName text,</span><br><span class="line">  jobgrade text,</span><br><span class="line">  empId text,</span><br><span class="line">  name text,</span><br><span class="line">  gender text,</span><br><span class="line">  <span class="keyword">primary</span> key(deptName, jobgrade, gender, empId)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- insert</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;001&#x27;</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;002&#x27;</span>, <span class="string">&#x27;Amy&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;003&#x27;</span>, <span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;004&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;005&#x27;</span>, <span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Female&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CASSANDRA.EMPLOYEE(deptName,jobgrade,empId,name,gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;Design&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;006&#x27;</span>, <span class="string">&#x27;Henry&#x27;</span>, <span class="string">&#x27;Male&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- select</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE;</span><br><span class="line"></span><br><span class="line">deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> gender <span class="operator">|</span> empid <span class="operator">|</span> name</span><br><span class="line"><span class="comment">----------+----------+--------+-------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">005</span> <span class="operator">|</span>  Mary</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">001</span> <span class="operator">|</span>   Tom</span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">002</span> <span class="operator">|</span>   Amy</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> Female <span class="operator">|</span>   <span class="number">004</span> <span class="operator">|</span> Alice</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">003</span> <span class="operator">|</span>  John</span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>   Male <span class="operator">|</span>   <span class="number">006</span> <span class="operator">|</span> Henry</span><br></pre></td></tr></table></figure>

<p>假設在RDBMS裡用以上建立的資料表，舉幾種查詢情境如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 依部門計數</span></span><br><span class="line"><span class="keyword">SELECT</span> deptname, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> deptname</span><br><span class="line"></span><br><span class="line">  deptname <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>     <span class="number">3</span></span><br><span class="line">   Design <span class="operator">|</span>     <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 依職等計數</span></span><br><span class="line"><span class="keyword">SELECT</span> jobgrade, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> jobgrade</span><br><span class="line"></span><br><span class="line"> jobgrade <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+-------</span></span><br><span class="line">        <span class="number">1</span> <span class="operator">|</span>     <span class="number">3</span></span><br><span class="line">        <span class="number">2</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">        <span class="number">2</span> <span class="operator">|</span>     <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 依部門, 職等計數</span></span><br><span class="line"><span class="keyword">SELECT</span> deptname, jobgrade, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> deptname, jobgrade</span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+----------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>     <span class="number">2</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="只能用在primary-key"><a href="#只能用在primary-key" class="headerlink" title="只能用在primary key"></a>只能用在primary key</h4><p>如同在Cassandra查詢資料一樣，Cassandra對於使用聚合函式也是有所限制。在使用聚合函式時，只能針對被設定為primary key的欄位使用GROUP BY，也就是聚合函式只能用在被定義為partition key或是clustering key的欄位，而且嚴格限制GROUP BY的順序。以下我們看在Cassandra執行第一支CQL的結果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 依部門計數</span></span><br><span class="line"><span class="keyword">SELECT</span> deptname, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> deptname</span><br><span class="line"></span><br><span class="line">  deptname <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>     <span class="number">3</span></span><br><span class="line">   Design <span class="operator">|</span>     <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Warnings :</span><br><span class="line">Aggregation query used <span class="keyword">without</span> <span class="keyword">partition</span> key</span><br></pre></td></tr></table></figure>
<p>因為deptname在這張表是partition key因此這支CQL可以被執行，但同時Cassandra會附帶警告訊息，表示這個聚合查詢沒有使用partition key。原因在於Cassandra會使用partition key在cluster中存放資料，如果沒有在CQL中使用partition key當作查詢條件，CQL在執行時便會在Cassandra cluster中遍尋(Full Scan)所有的資料，這會造成效能降低與資源浪費。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 依部門計數</span></span><br><span class="line"><span class="keyword">SELECT</span> deptname, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">WHERE</span> deptname <span class="operator">=</span> <span class="string">&#x27;HR&#x27;</span></span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> deptname</span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>如果加上deptname當作查詢條件就不會出現警告訊息，這時Cassandra會直接從存放資料的node取出deptname=HR的資料作計數，而不需要遍尋整座Cassandra cluster。</p>
<h4 id="必須依照primary-key順序"><a href="#必須依照primary-key順序" class="headerlink" title="必須依照primary key順序"></a>必須依照primary key順序</h4><p>接著我們看第二支CQL，第二支CQL在執行時會出現以下的錯誤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 依職等計數</span></span><br><span class="line"><span class="keyword">SELECT</span> jobgrade, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> jobgrade</span><br><span class="line"></span><br><span class="line"> InvalidRequest: Error <span class="keyword">from</span> server: code<span class="operator">=</span><span class="number">2200</span> [Invalid query] message<span class="operator">=</span>&quot;Group by currently only support groups of columns following their declared order in the PRIMARY KEY&quot;</span><br></pre></td></tr></table></figure>

<p>當在Cassandra中執行GROUP BY時，必須要依照primary key的順序，也就是deptname、jobgrade和gender這個順序，跳過deptname直接使用jobgrade或是gender作GROUP BY是不允許的。</p>
<p>其中原因在於Cassandra使用partition key決定資料存放的位置，並在每份partion中使用clustering key決定資料的排序順序。因此如果要對沒有任何索引的非primary key欄位作分組計算，就會需要遍尋Cassandra cluster。</p>
<p>第三支CQL因為符合partition和clustering的順序限制所以可以成功執行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 依部門, 職等計數</span></span><br><span class="line"><span class="keyword">SELECT</span> deptname, jobgrade, <span class="built_in">count</span>(<span class="operator">*</span>) </span><br><span class="line">  <span class="keyword">FROM</span> CASSANDRA.EMPLOYEE</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> deptname, jobgrade</span><br><span class="line"></span><br><span class="line"> deptname <span class="operator">|</span> jobgrade <span class="operator">|</span> count</span><br><span class="line"><span class="comment">----------+----------+-------</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>     <span class="number">2</span></span><br><span class="line">       HR <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>     <span class="number">1</span></span><br><span class="line">   Design <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span>     <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>從以上查詢範例可以發現Cassandra在使用聚合函式時會受限於資料表primary key設計，並不是所有的欄位都能使用。因此如果預期會對資料欄位作聚合函式的計算，就必須預先在建立資料表就放進primary key中。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Drake"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Drake</p>
  <div class="site-description" itemprop="description">Chase excellence, success will follow!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qiubite31" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qiubite31" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/yu-long-lin/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yu-long-lin&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Drake</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 強力驅動
  </div>

        




  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-firestore.js"></script>
  <script>
    firebase.initializeApp({
      apiKey   : 'AIzaSyBailFMNgblDDESyjXCS-hLzrVQuP0sUx0',
      projectId: 'myblog-313416'
    });

    function getCount(doc, increaseCount) {
      // IncreaseCount will be false when not in article page
      return doc.get().then(d => {
        var count = 0;
        if (!d.exists) { // Has no data, initialize count
          if (increaseCount) {
            doc.set({
              count: 1
            });
            count = 1;
          }
        } else { // Has data
          count = d.data().count;
          if (increaseCount) {
            // If first view this article
            doc.set({ // Increase count
              count: count + 1
            });
            count++;
          }
        }

        return count;
      });
    }

    function appendCountTo(el) {
      return count => {
        el.innerText = count;
      }
    }
  </script>
  <script>
    (function() {
      var db = firebase.firestore();
      var articles = db.collection('articles');

      if (CONFIG.page.isPost) { // Is article page
        var title = document.querySelector('.post-title').innerText.trim();
        var doc = articles.doc(title);
        var increaseCount = CONFIG.hostname === location.hostname;
        if (localStorage.getItem(title)) {
          increaseCount = false;
        } else {
          // Mark as visited
          localStorage.setItem(title, true);
        }
        getCount(doc, increaseCount).then(appendCountTo(document.querySelector('.firestore-visitors-count')));
      } else if (CONFIG.page.isHome) { // Is index page
        var promises = [...document.querySelectorAll('.post-title')].map(element => {
          var title = element.innerText.trim();
          var doc = articles.doc(title);
          return getCount(doc);
        });
        Promise.all(promises).then(counts => {
          var metas = document.querySelectorAll('.firestore-visitors-count');
          counts.forEach((val, idx) => {
            appendCountTo(metas[idx])(val);
          });
        });
      }
    })();
  </script>




      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://dragonlogdown.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>


</body>
</html>
