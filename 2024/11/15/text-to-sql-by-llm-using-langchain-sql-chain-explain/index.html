<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qiubite31.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="上一篇透過Langchain SQL Chain建立資料問答系統中使用Langchain的sql query chain能夠快速開發資料問答功能。雖然Langchain提供了方便的開發模組，但卻封裝了許多與大型語言互動的細節。我們可以嘗試的從原始碼來看幾個Langchain封裝起來的細節。 和LLM互動的prompt在這篇使用大型語言模型(LLM)完成Text-to-SQL任務可以看到要把輸入的問">
<meta property="og:type" content="article">
<meta property="og:title" content="使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Chain說明">
<meta property="og:url" content="https://qiubite31.github.io/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/index.html">
<meta property="og:site_name" content="Drake&#39;s">
<meta property="og:description" content="上一篇透過Langchain SQL Chain建立資料問答系統中使用Langchain的sql query chain能夠快速開發資料問答功能。雖然Langchain提供了方便的開發模組，但卻封裝了許多與大型語言互動的細節。我們可以嘗試的從原始碼來看幾個Langchain封裝起來的細節。 和LLM互動的prompt在這篇使用大型語言模型(LLM)完成Text-to-SQL任務可以看到要把輸入的問">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2024-11-15T05:26:12.000Z">
<meta property="article:modified_time" content="2024-12-03T17:56:49.819Z">
<meta property="article:author" content="Drake">
<meta property="article:tag" content="Machine Learning">
<meta property="article:tag" content="SQL">
<meta property="article:tag" content="Text-to-SQL">
<meta property="article:tag" content="LLM">
<meta property="article:tag" content="prompt">
<meta property="article:tag" content="LangChain">
<meta property="article:tag" content="Gemini">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qiubite31.github.io/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Chain說明 | Drake's</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-82135937-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-82135937-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Drake's</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://qiubite31.github.io/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Drake">
      <meta itemprop="description" content="Chase excellence, success will follow!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Drake's">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Chain說明
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-11-15 13:26:12" itemprop="dateCreated datePublished" datetime="2024-11-15T13:26:12+08:00">2024-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2024-12-04 01:56:49" itemprop="dateModified" datetime="2024-12-04T01:56:49+08:00">2024-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="閱讀次數">
              <span class="post-meta-item-icon">
                <i class="fa fa-users"></i>
              </span>
              <span class="post-meta-item-text">閱讀次數：</span>
              <span class="firestore-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>上一篇<a href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/">透過Langchain SQL Chain建立資料問答系統</a>中使用Langchain的sql query chain能夠快速開發資料問答功能。雖然Langchain提供了方便的開發模組，但卻封裝了許多與大型語言互動的細節。我們可以嘗試的從原始碼來看幾個Langchain封裝起來的細節。</p>
<h4 id="和LLM互動的prompt"><a href="#和LLM互動的prompt" class="headerlink" title="和LLM互動的prompt"></a>和LLM互動的prompt</h4><p>在這篇<a href="/2024/10/06/text-to-sql-by-llm/">使用大型語言模型(LLM)完成Text-to-SQL任務</a>可以看到要把輸入的問題轉成SQL查詢，和LLM互動時會需要準備prompt，如果有自己準備prompt的話，就能在呼叫<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L36">create_sql_query_chain帶進prompt</a>參數。如果沒有的話，Langchain會預設使用<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py">sql_database的prompt</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.sql_database.prompt <span class="keyword">import</span> SQL_PROMPTS</span><br><span class="line">SQL_PROMPTS[db.dialect].pretty_print() <span class="comment"># sqlite</span></span><br></pre></td></tr></table></figure>

<p>在呼叫<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L33">create_sql_query_chain</a>且沒有提供prompt的情況下，會從SQLDatabase取得<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L116">dialect</a>，再從Langchain的sql_database取出對應資料庫的<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py">prompt</a>。目前Langchain提供11種<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/prompt.py#L272">database prompt</a>，每一種資料庫的prompt都有所不同，特別是在current date的寫法會不同。</p>
<p>以下是以SQLite為例，這prompt中會有三個在過程中會被帶入的參數，分別為top_k、table_info和input。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">You are a SQLite expert. Given an input question, first create a syntactically correct SQLite query to run, then look at the results of the query and return the answer to the input question.</span><br><span class="line">Unless the user specifies in the question a specific number of examples to obtain, query for at most &#123;top_k&#125; results using the LIMIT clause as per SQLite. You can order the results to return the most informative data in the database.</span><br><span class="line">Never query for all columns from a table. You must query only the columns that are needed to answer the question. Wrap each column name in double quotes (&quot;) to denote them as delimited identifiers.</span><br><span class="line">Pay attention to use only the column names you can see in the tables below. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span><br><span class="line">Pay attention to use date(&#x27;now&#x27;) function to get the current date, if the question involves &quot;today&quot;.</span><br><span class="line"></span><br><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: Question here</span><br><span class="line">SQLQuery: SQL Query to run</span><br><span class="line">SQLResult: Result of the SQLQuery</span><br><span class="line">Answer: Final answer here</span><br><span class="line"></span><br><span class="line">Only use the following tables:</span><br><span class="line">&#123;table_info&#125;</span><br><span class="line"></span><br><span class="line">Question: &#123;input&#125;</span><br></pre></td></tr></table></figure>

<h4 id="prompt內置換的變數"><a href="#prompt內置換的變數" class="headerlink" title="prompt內置換的變數"></a>prompt內置換的變數</h4><h5 id="top-k"><a href="#top-k" class="headerlink" title="top_k"></a>top_k</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># langchain/langchain/chains/sql_database/query.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_sql_query_chain</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    llm: BaseLanguageModel,</span></span></span><br><span class="line"><span class="params"><span class="function">    db: SQLDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    prompt: <span class="type">Optional</span>[BasePromptTemplate] = <span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    k: <span class="built_in">int</span> = <span class="number">5</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment"># top_k = 5</span></span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L37">top_k</a>本身在<a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L33">create_sql_query_chain</a>就是一個輸入參數，如果不指定的話預設值會是5。</p>
<h5 id="input"><a href="#input" class="headerlink" title="input"></a>input</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># langchain/langchain/chains/sql_database/query.py</span></span><br><span class="line">inputs = &#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="keyword">lambda</span> x: x[<span class="string">&quot;question&quot;</span>] + <span class="string">&quot;\nSQLQuery: &quot;</span>,</span><br><span class="line">    <span class="string">&quot;table_info&quot;</span>: <span class="keyword">lambda</span> x: db.get_table_info(</span><br><span class="line">        table_names=x.get(<span class="string">&quot;table_names_to_use&quot;</span>)</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># chain.invoke(&#123;&quot;question&quot;: &quot;How many employees are there&quot;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># input = How Many employees are there</span></span><br><span class="line"><span class="comment">#         SQLQuery: </span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L131">input</a>會從參數dict取出question，就是對應到在invoke時帶入的問題，接著會在問題後接SQLQuery用來讓LLM往後生成SQL查詢。</p>
<h5 id="table-info"><a href="#table-info" class="headerlink" title="table_info"></a>table_info</h5><p><a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/sql_database/query.py#L131">table_info</a>會呼叫SQLDatabase的get_table_info函式，這個函式的作用是查找出資料庫內的資料表schmea加三筆資料，而且這裡可以接受帶入一個List參數table_names_to_use正向表列要查的資料表。注意如果不指定資料表，get_table_info會帶出所有的資料表資訊。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.get_table_info(table_names=[<span class="string">&quot;Employee&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>實際使用這個函式並帶入資料表名稱，就會取得以下的資訊。這裡的目的就是要讓LLM看懂資料表名稱、欄位清單，還有範例的資料，讓LLM可以更準確的將問題轉成SQL。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<h4 id="完整的prompt"><a href="#完整的prompt" class="headerlink" title="完整的prompt"></a>完整的prompt</h4><p>總結以上的prompt template加上top_k、table_info和input三個要代入的參數，最後完整丟給LLM的prompt如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">You are a SQLite expert. Given an input question, first create a syntactically correct SQLite query to run, then look at the results of the query and return the answer to the input question.</span><br><span class="line">Unless the user specifies in the question a specific number of examples to obtain, query for at most 5 results using the LIMIT clause as per SQLite. You can order the results to return the most informative data in the database.</span><br><span class="line">Never query for all columns from a table. You must query only the columns that are needed to answer the question. Wrap each column name in double quotes (&quot;) to denote them as delimited identifiers.</span><br><span class="line">Pay attention to use only the column names you can see in the tables below. Be careful to not query for columns that do not exist. Also, pay attention to which column is in which table.</span><br><span class="line">Pay attention to use date(&#x27;now&#x27;) function to get the current date, if the question involves &quot;today&quot;.</span><br><span class="line"></span><br><span class="line">Use the following format:</span><br><span class="line"></span><br><span class="line">Question: Question here</span><br><span class="line">SQLQuery: SQL Query to run</span><br><span class="line">SQLResult: Result of the SQLQuery</span><br><span class="line">Answer: Final answer here</span><br><span class="line"></span><br><span class="line">Only use the following tables:</span><br><span class="line">CREATE TABLE &quot;Employee&quot; (</span><br><span class="line">	&quot;EmployeeId&quot; INTEGER NOT NULL, </span><br><span class="line">	&quot;LastName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;FirstName&quot; NVARCHAR(20) NOT NULL, </span><br><span class="line">	&quot;Title&quot; NVARCHAR(30), </span><br><span class="line">	&quot;ReportsTo&quot; INTEGER, </span><br><span class="line">	&quot;BirthDate&quot; DATETIME, </span><br><span class="line">	&quot;HireDate&quot; DATETIME, </span><br><span class="line">	&quot;Address&quot; NVARCHAR(70), </span><br><span class="line">	&quot;City&quot; NVARCHAR(40), </span><br><span class="line">	&quot;State&quot; NVARCHAR(40), </span><br><span class="line">	&quot;Country&quot; NVARCHAR(40), </span><br><span class="line">	&quot;PostalCode&quot; NVARCHAR(10), </span><br><span class="line">	&quot;Phone&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Fax&quot; NVARCHAR(24), </span><br><span class="line">	&quot;Email&quot; NVARCHAR(60), </span><br><span class="line">	PRIMARY KEY (&quot;EmployeeId&quot;), </span><br><span class="line">	FOREIGN KEY(&quot;ReportsTo&quot;) REFERENCES &quot;Employee&quot; (&quot;EmployeeId&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">3 rows from Employee table:</span><br><span class="line">EmployeeId	LastName	FirstName	Title	ReportsTo	BirthDate	HireDate	Address	City	State	Country	PostalCode	Phone	Fax	Email</span><br><span class="line">1	Adams	Andrew	General Manager	None	1962-02-18 00:00:00	2002-08-14 00:00:00	11120 Jasper Ave NW	Edmonton	AB	Canada	T5K 2N1	+1 (780) 428-9482	+1 (780) 428-3457	andrew@chinookcorp.com</span><br><span class="line">2	Edwards	Nancy	Sales Manager	1	1958-12-08 00:00:00	2002-05-01 00:00:00	825 8 Ave SW	Calgary	AB	Canada	T2P 2T3	+1 (403) 262-3443	+1 (403) 262-3322	nancy@chinookcorp.com</span><br><span class="line">3	Peacock	Jane	Sales Support Agent	2	1973-08-29 00:00:00	2002-04-01 00:00:00	1111 6 Ave SW	Calgary	AB	Canada	T2P 5M5	+1 (403) 262-3443	+1 (403) 262-6712	jane@chinookcorp.com</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">Question: How Many employees are there</span><br><span class="line">SQLQuery: </span><br></pre></td></tr></table></figure>

<p>如果要把table_names_to_use帶入資料表清單，可以用RunnablePassthrough作assign，注意如果資料表不存在資料庫中會回傳table_names not found in database。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.tools.sql_database.tool <span class="keyword">import</span> QuerySQLDataBaseTool</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line">execute_query = QuerySQLDataBaseTool(db=db, verbose=<span class="literal">True</span>)</span><br><span class="line">write_query = create_sql_query_chain(llm, db)</span><br><span class="line"></span><br><span class="line">chain = (</span><br><span class="line">    <span class="comment"># assign table_names_to_use</span></span><br><span class="line">    RunnablePassthrough.assign(table_names_to_use=RunnableLambda(<span class="keyword">lambda</span> x: [<span class="string">&#x27;Employee&#x27;</span>])) </span><br><span class="line">    | write_query</span><br><span class="line">    | RunnableLambda(<span class="keyword">lambda</span> x: parse_sql(x))</span><br><span class="line">    | execute_query</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;How many employees are there&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(8,)]</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
              <a href="/tags/SQL/" rel="tag"># SQL</a>
              <a href="/tags/Text-to-SQL/" rel="tag"># Text-to-SQL</a>
              <a href="/tags/LLM/" rel="tag"># LLM</a>
              <a href="/tags/prompt/" rel="tag"># prompt</a>
              <a href="/tags/LangChain/" rel="tag"># LangChain</a>
              <a href="/tags/Gemini/" rel="tag"># Gemini</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/10/29/text-to-sql-by-llm-using-langchain-sql-chain/" rel="prev" title="使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Chain建立資料問答系統">
      <i class="fa fa-chevron-left"></i> 使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Chain建立資料問答系統
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/12/05/text-to-sql-by-llm-using-langchain-sql-agent/" rel="next" title="使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Agent建立資料問答系統">
      使用大型語言模型(LLM)完成Text-to-SQL任務 - 透過Langchain SQL Agent建立資料問答系統 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
            <li class="tab"><a href="#comment-gitalk">gitalk</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%92%8CLLM%E4%BA%92%E5%8B%95%E7%9A%84prompt"><span class="nav-number">1.</span> <span class="nav-text">和LLM互動的prompt</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prompt%E5%85%A7%E7%BD%AE%E6%8F%9B%E7%9A%84%E8%AE%8A%E6%95%B8"><span class="nav-number">2.</span> <span class="nav-text">prompt內置換的變數</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#top-k"><span class="nav-number">2.1.</span> <span class="nav-text">top_k</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#input"><span class="nav-number">2.2.</span> <span class="nav-text">input</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#table-info"><span class="nav-number">2.3.</span> <span class="nav-text">table_info</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84prompt"><span class="nav-number">3.</span> <span class="nav-text">完整的prompt</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Drake"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Drake</p>
  <div class="site-description" itemprop="description">Chase excellence, success will follow!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qiubite31" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qiubite31" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/yu-long-lin/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yu-long-lin&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Drake</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 強力驅動
  </div>

        




  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-firestore.js"></script>
  <script>
    firebase.initializeApp({
      apiKey   : 'AIzaSyBailFMNgblDDESyjXCS-hLzrVQuP0sUx0',
      projectId: 'myblog-313416'
    });

    function getCount(doc, increaseCount) {
      // IncreaseCount will be false when not in article page
      return doc.get().then(d => {
        var count = 0;
        if (!d.exists) { // Has no data, initialize count
          if (increaseCount) {
            doc.set({
              count: 1
            });
            count = 1;
          }
        } else { // Has data
          count = d.data().count;
          if (increaseCount) {
            // If first view this article
            doc.set({ // Increase count
              count: count + 1
            });
            count++;
          }
        }

        return count;
      });
    }

    function appendCountTo(el) {
      return count => {
        el.innerText = count;
      }
    }
  </script>
  <script>
    (function() {
      var db = firebase.firestore();
      var articles = db.collection('articles');

      if (CONFIG.page.isPost) { // Is article page
        var title = document.querySelector('.post-title').innerText.trim();
        var doc = articles.doc(title);
        var increaseCount = CONFIG.hostname === location.hostname;
        if (localStorage.getItem(title)) {
          increaseCount = false;
        } else {
          // Mark as visited
          localStorage.setItem(title, true);
        }
        getCount(doc, increaseCount).then(appendCountTo(document.querySelector('.firestore-visitors-count')));
      } else if (CONFIG.page.isHome) { // Is index page
        var promises = [...document.querySelectorAll('.post-title')].map(element => {
          var title = element.innerText.trim();
          var doc = articles.doc(title);
          return getCount(doc);
        });
        Promise.all(promises).then(counts => {
          var metas = document.querySelectorAll('.firestore-visitors-count');
          counts.forEach((val, idx) => {
            appendCountTo(metas[idx])(val);
          });
        });
      }
    })();
  </script>




      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://dragonlogdown.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://qiubite31.github.io/2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/";
    this.page.identifier = "2024/11/15/text-to-sql-by-llm-using-langchain-sql-chain-explain/";
    this.page.title = "使用大型語言模型(LLM)完成Text-to-SQL任務 - Langchain SQL Chain說明";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://dragonlogdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '5c8a759a54d2c62d9d15',
      clientSecret: '911b431c408e3c0ee3c0968375cbd3efdee9abb9',
      repo        : 'qiubite31.github.io',
      owner       : 'qiubite31',
      admin       : ['qiubite31'],
      id          : 'ddc475b28f90ec24aca3164307de6839',
        language: 'zh-TW',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
